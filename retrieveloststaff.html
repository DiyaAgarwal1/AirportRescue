<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="css/retrivestyle.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <title>Trouve Voyager</title>
</head>

<body>
  <h3>Lost Items</h3>
  <div class="container mt-3">
    <table class="table table-dark">
      <thead>
        <tr>
          <th>Remarks</th>
          <th>Sno</th>
          <th>Name</th>
          <th>Item</th>
          <th>Can you track it</th>
          <th>Arrival date</th>
          <th>Mobile Number</th>
          <th>Edit</th>
        </tr>
      </thead>
      <tbody id="tbody1"></tbody>
    </table>
  </div>

  <script type="module">
    var sno = 0;
    var tbody = document.getElementById('tbody1');

    function AddItemToTable(remarks, name, item, track, arrdate, number, key) {
      let trow = document.createElement("tr");
      let tdRemarks = document.createElement("td");
      let tdSno = document.createElement("td");
      let tdName = document.createElement("td");
      let tdItem = document.createElement("td");
      let tdTrack = document.createElement("td");
      let tdArrDate = document.createElement("td");
      let tdNumber = document.createElement("td");
      let tdEditButton = document.createElement("td");

      tdRemarks.innerHTML = remarks;
      tdSno.innerHTML = ++sno;
      tdName.innerHTML = name;
      tdItem.innerHTML = item;
      tdTrack.innerHTML = track;
      tdArrDate.innerHTML = arrdate;
      tdNumber.innerHTML = number;
      tdEditButton.innerHTML = "<button class='btn btn-success edit-btn' data-key='" + key + "'>Edit</button>";

      trow.appendChild(tdRemarks);
      trow.appendChild(tdSno);
      trow.appendChild(tdName);
      trow.appendChild(tdItem);
      trow.appendChild(tdTrack);
      trow.appendChild(tdArrDate);
      trow.appendChild(tdNumber);
      trow.appendChild(tdEditButton);
      tbody.appendChild(trow);
    }

    function AddAllItemsToTable(TheCustomer) {
      sno = 0;
      tbody.innerHTML = "";
      TheCustomer.forEach(element => {
        AddItemToTable(element.remarks, element.name, element.item, element.track, element.arrdate, element.number, element.key);
      });
    }

    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import {
      getDatabase,
      set,
      ref,
      onValue,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-analytics.js";

    const firebaseConfig = {
    apiKey: "AIzaSyC8iSc60XNYv4M5V_s4n3gbM61uAYrCpXs",
    authDomain: "port-rescue-70d10.firebaseapp.com",
    databaseURL: "https://port-rescue-70d10-default-rtdb.firebaseio.com",
    projectId: "port-rescue-70d10",
    storageBucket: "port-rescue-70d10.appspot.com",
    messagingSenderId: "596330923712",
    appId: "1:596330923712:web:b9d6ae26f1c4e128cc8f25",
    measurementId: "G-Q1LC8S84FG"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase();

    function GetAllDataOnce() {
        const dbref = ref(db);

        get(child(dbref, "Lost Items"))
            .then((snapshot) => {
                var customer = [];
                snapshot.forEach(childSnapshot => {
                    const key = childSnapshot.key;
                    const data = childSnapshot.val();
                    customer.push({ ...data, key });
                });
                AddAllItemsToTable(customer);
            });
    }

    function GetAllDataRealtime() {
        const dbref = ref(db, "Lost Items/");

        onValue(dbref, (snapshot) => {
            var customer = [];
            snapshot.forEach(childSnapshot => {
                const key = childSnapshot.key;
                const data = childSnapshot.val();
                customer.push({ ...data, key });
            });
            AddAllItemsToTable(customer);
        });
    }

    window.onload = GetAllDataOnce();

    // Edit button click event listener
    document.addEventListener("click", (event) => {
        if (event.target.classList.contains("edit-btn")) {
            const remarksCell = event.target.parentNode.parentNode.cells[0];
            const remarksValue = remarksCell.innerHTML.trim();
            const newRemarks = prompt("Enter remarks", remarksValue);
            if (newRemarks !== null) {
                remarksCell.innerHTML = newRemarks;
                const itemKey = event.target.getAttribute("data-key");
                UpdateRemarksInDatabase(itemKey, newRemarks);
            }
        }
    });

    function UpdateRemarksInDatabase(key, newRemarks) {
        const itemRef = ref(db, "Lost Items/" + key);
        set(itemRef, { remarks: newRemarks })
            .then(() => {
                console.log("Remarks updated successfully.");
            })
            .catch((error) => {
                console.error("Error updating remarks: ", error);
            });
    }
</script>

</body>
</html>
